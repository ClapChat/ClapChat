<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clap Chat â€” Home</title>
<style>
  :root{
    --bg:#1e1e1e; --panel:#2a2a2a; --muted:#3a3a3a; --accent:#a26fff; --accent2:#6fa2ff; --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#fff;height:100vh;display:flex;flex-direction:column}
  .topbar{padding:14px 18px;background:var(--panel);display:flex;justify-content:space-between;align-items:center;color:var(--accent);font-weight:700}
  .main{flex:1;display:flex;gap:16px;padding:16px}
  .sidebar{width:320px;display:flex;flex-direction:column;gap:14px}
  .section{background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .section h3{margin:0;color:var(--accent);font-size:14px;text-align:center}
  .list{display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto;padding:4px}
  .row{background:var(--muted);padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .row:hover{background:#4b3a66}
  .actions{display:flex;gap:8px}
  button{cursor:pointer;border:0;border-radius:8px;padding:6px 10px;background:var(--accent);color:#fff}
  button.small{padding:5px 8px;border-radius:6px;font-size:13px}
  button.ghost{background:transparent;border:1px solid #444;color:#ddd;padding:6px;border-radius:8px}
  .chat-area{flex:1;display:flex;flex-direction:column;gap:10px}
  #chatHead{display:flex;justify-content:space-between;align-items:center}
  #chatTitle{color:var(--accent);font-weight:700}
  #chatActions{display:flex;gap:8px;flex-wrap:wrap}
  .messages{flex:1;background:var(--panel);padding:12px;border-radius:12px;overflow:auto;display:flex;flex-direction:column;gap:8px}
  .message{max-width:72%;padding:10px;border-radius:10px;position:relative;word-break:break-word}
  .message.self{background:#4b3a66;align-self:flex-end;padding-right:44px}
  .message.other{background:var(--muted);align-self:flex-start;padding-right:44px}
  .message.system{align-self:center;background:transparent;color:#bbb;font-style:italic;padding:6px}
  .msg-sender{font-weight:700;margin-right:6px}
  .delete-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:#bbb;opacity:0;cursor:pointer;padding:6px;border-radius:6px}
  .message:hover .delete-btn{opacity:1}
  .send-row{display:flex;gap:8px;margin-top:8px}
  input[type=text]{flex:1;padding:10px;border-radius:10px;border:0;background:var(--muted);color:#fff}
  input[type=file]{display:none}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;justify-content:center;align-items:center;z-index:60}
  .card{background:var(--panel);padding:14px;border-radius:10px;min-width:300px;max-height:75vh;overflow:auto}
  .member-item{background:#3a3a3a;padding:8px;border-radius:8px;margin-bottom:6px}
  .danger{background:var(--danger);color:#000}
  /* small scrollbars */
  .list::-webkit-scrollbar,.messages::-webkit-scrollbar{width:8px;height:8px}
  .list::-webkit-scrollbar-thumb,.messages::-webkit-scrollbar-thumb{background:#333;border-radius:6px}
</style>
</head>
<body>

<div class="topbar">
  Clap Chat
  <div style="display:flex;gap:12px;align-items:center">
    <div id="userLabel" style="font-weight:600"></div>
    <button id="logout" class="small ghost">Logout</button>
  </div>
</div>

<div class="main">
  <!-- Left Sidebar -->
  <div class="sidebar">
    <div class="section">
      <div id="userWelcome" style="text-align:center;color:#fff;font-size:13px"></div>
      <h3>Friends</h3>
      <div class="list" id="friendsList"></div>
      <div style="display:flex;gap:8px">
        <input id="friendInput" type="text" placeholder="username" />
        <button id="friendAdd" class="small">Add</button>
      </div>
      <div id="friendMsg" style="height:18px;color:#aaa;font-size:13px"></div>
    </div>

    <div class="section">
      <h3>Groups</h3>
      <div class="list" id="groupsList"></div>
      <div style="display:flex;gap:8px">
        <button id="openCreateGroup" class="small">New Group</button>
      </div>
    </div>

    <div class="section">
      <h3>Notifications</h3>
      <div class="list" id="notificationsList"></div>
    </div>
  </div>

  <!-- Chat area -->
  <div class="chat-area">
    <div id="chatHead">
      <div id="chatTitle">Select a friend or group to chat</div>
      <div id="chatActions"></div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="send-row">
      <input id="textBox" type="text" placeholder="Type a message" />
      <input id="fileInput" type="file" accept="image/*" />
      <button id="imgBtn">ðŸ“·</button>
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- Create Group Modal -->
<div class="modal" id="createModal">
  <div class="card">
    <h3>Create Group</h3>
    <div id="createFriends"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="createName" type="text" placeholder="Group name (optional)">
      <button id="createConfirm" class="small">Create</button>
    </div>
    <div style="text-align:right;margin-top:8px"><button id="createClose" class="small ghost">Close</button></div>
  </div>
</div>

<!-- Members Modal -->
<div class="modal" id="membersModal">
  <div class="card">
    <h3>Members</h3>
    <div id="membersList"></div>
    <div style="text-align:right;margin-top:8px"><button id="membersClose" class="small">Close</button></div>
  </div>
</div>

<!-- Kick Modal -->
<div class="modal" id="kickModal">
  <div class="card">
    <h3>Kick member</h3>
    <div id="kickList"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="kickCancel" class="small ghost">Cancel</button>
      <button id="kickDo" class="small danger">Kick</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script>
/* ---------------- Firebase config ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCk8Iwb8sFF90ToYE44l8d95uKSB-jPBU8",
  authDomain: "clapchat-852a6.firebaseapp.com",
  projectId: "clapchat-852a6",
  storageBucket: "clapchat-852a6.firebasestorage.app",
  messagingSenderId: "918530152107",
  appId: "1:918530152107:web:87f233eaae46c2178a89ee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------------- UI refs ---------------- */
const userLabel = document.getElementById('userLabel');
const userWelcome = document.getElementById('userWelcome');
const friendsList = document.getElementById('friendsList');
const groupsList = document.getElementById('groupsList');
const notificationsList = document.getElementById('notificationsList');
const friendInput = document.getElementById('friendInput');
const friendAdd = document.getElementById('friendAdd');
const friendMsg = document.getElementById('friendMsg');

const chatTitle = document.getElementById('chatTitle');
const chatActions = document.getElementById('chatActions');
const messagesEl = document.getElementById('messages');
const textBox = document.getElementById('textBox');
const fileInput = document.getElementById('fileInput');
const imgBtn = document.getElementById('imgBtn');
const sendBtn = document.getElementById('sendBtn');

const createModal = document.getElementById('createModal');
const createFriends = document.getElementById('createFriends');
const createName = document.getElementById('createName');
const createConfirm = document.getElementById('createConfirm');
const createClose = document.getElementById('createClose');
const openCreateGroup = document.getElementById('openCreateGroup');

const membersModal = document.getElementById('membersModal');
const membersList = document.getElementById('membersList');
const membersClose = document.getElementById('membersClose');

const kickModal = document.getElementById('kickModal');
const kickList = document.getElementById('kickList');
const kickCancel = document.getElementById('kickCancel');
const kickDo = document.getElementById('kickDo');

const logout = document.getElementById('logout');

/* ---------------- State ---------------- */
const username = localStorage.getItem('currentUser');
if(!username){ window.location.href='index.html'; throw 'no user'; }
userLabel.textContent = username;
userWelcome.textContent = `Welcome, ${username}`;

let currentChatId = null;           // doc id (dm id or group id)
let currentChatIsGroup = false;
let currentGroupUnsub = null;
let currentMessagesUnsub = null;
let currentGroupData = null;

/* ---------------- Helpers ---------------- */
function clear(node){ while(node.firstChild) node.removeChild(node.firstChild); }
function show(modal){ modal.style.display='flex'; }
function hide(modal){ modal.style.display='none'; }
async function addSystem(chatId, text){
  await db.collection('chats').doc(chatId).collection('messages').add({
    sender: 'System', text, timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
}

/* ---------------- Load friends, notifications, groups ---------------- */
function loadFriends(){
  db.collection('users').doc(username).onSnapshot(doc=>{
    clear(friendsList);
    if(!doc.exists) return;
    const friends = doc.data().friends || [];
    friends.forEach(f=>{
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `<div>${f}</div>`;
      const act = document.createElement('div'); act.className='actions';
      const groupBtn = document.createElement('button'); groupBtn.className='small'; groupBtn.textContent='Group';
      groupBtn.onclick = (e)=>{ e.stopPropagation(); openCreateForFriend(f); };
      const removeBtn = document.createElement('button'); removeBtn.className='small ghost'; removeBtn.textContent='Remove';
      removeBtn.onclick = (e)=>{ e.stopPropagation(); db.collection('users').doc(username).update({friends: firebase.firestore.FieldValue.arrayRemove(f)}); db.collection('users').doc(f).update({friends: firebase.firestore.FieldValue.arrayRemove(username)}); };
      act.appendChild(groupBtn); act.appendChild(removeBtn);
      row.appendChild(act);
      row.onclick = ()=> openDM(f);
      friendsList.appendChild(row);
    });
  });
}

function loadNotifications(){
  db.collection('users').doc(username).onSnapshot(doc=>{
    clear(notificationsList);
    if(!doc.exists) return;
    const reqs = doc.data().friendRequests || [];
    reqs.forEach(r=>{
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `<div>${r}</div>`;
      const act = document.createElement('div'); act.className='actions';
      const accept = document.createElement('button'); accept.className='small'; accept.textContent='Accept';
      accept.onclick = (e)=>{ e.stopPropagation(); db.collection('users').doc(username).update({friends: firebase.firestore.FieldValue.arrayUnion(r), friendRequests: firebase.firestore.FieldValue.arrayRemove(r)}); db.collection('users').doc(r).update({friends: firebase.firestore.FieldValue.arrayUnion(username)}); };
      const decline = document.createElement('button'); decline.className='small ghost'; decline.textContent='Decline';
      decline.onclick = (e)=>{ e.stopPropagation(); db.collection('users').doc(username).update({friendRequests: firebase.firestore.FieldValue.arrayRemove(r)}); };
      act.appendChild(accept); act.appendChild(decline);
      row.appendChild(act);
      notificationsList.appendChild(row);
    });
  });
}

function loadGroups(){
  db.collection('chats').where('isGroup','==',true).where('members','array-contains',username)
    .onSnapshot(snap=>{
      clear(groupsList);
      snap.forEach(doc=>{
        const d = doc.data();
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `<div>${d.groupName || '(no name)'}</div>`;
        row.onclick = ()=> openGroup(doc.id);
        groupsList.appendChild(row);
      });
    });
}

/* ---------------- Add friend (validate exists) ---------------- */
friendAdd.onclick = async ()=>{
  const name = (friendInput.value||'').trim();
  if(!name){ friendMsg.textContent=''; return; }
  if(name === username){ friendMsg.style.color='#ff6b6b'; friendMsg.textContent="Can't add yourself"; return; }
  const doc = await db.collection('users').doc(name).get();
  if(!doc.exists){ friendMsg.style.color='#ff6b6b'; friendMsg.textContent='Invalid user'; return; }
  await db.collection('users').doc(name).update({friendRequests: firebase.firestore.FieldValue.arrayUnion(username)});
  friendMsg.style.color='#7cff9b'; friendMsg.textContent='Request sent';
  friendInput.value=''; setTimeout(()=>friendMsg.textContent='',1600);
};

/* ---------------- Create group flows ---------------- */
function openCreateForFriend(pre){
  openCreateModal(pre);
}
openCreateGroup.onclick = ()=> openCreateModal(null);

function openCreateModal(preselect){
  clear(createFriends);
  db.collection('users').doc(username).get().then(doc=>{
    if(!doc.exists) return;
    const friends = doc.data().friends || [];
    friends.forEach(f=>{
      const label = document.createElement('label'); label.style.display='block'; label.style.marginBottom='6px';
      label.innerHTML = `<input type="checkbox" value="${f}"> ${f}`;
      createFriends.appendChild(label);
    });
    if(preselect){
      const preEl = document.createElement('div'); preEl.className='member-item'; preEl.textContent = 'Preselected: ' + preselect;
      createFriends.insertBefore(preEl, createFriends.firstChild);
    }
    show(createModal);
  });
}
createClose.onclick = ()=> hide(createModal);

createConfirm.onclick = async ()=>{
  const checked = Array.from(createFriends.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
  const pre = createFriends.querySelector('.member-item');
  if(pre && pre.textContent.startsWith('Preselected: ')) checked.push(pre.textContent.replace('Preselected: ',''));
  checked.push(username);
  const name = (createName.value || 'New Group').trim();
  const id = 'group_' + Date.now();
  await db.collection('chats').doc(id).set({isGroup:true,groupName:name,owner:username,members:checked});
  hide(createModal); createName.value='';
};

/* ---------------- Open DM ---------------- */
async function openDM(friend){
  // unsubscribe previous
  if(currentMessagesUnsub) currentMessagesUnsub();
  if(currentGroupUnsub) currentGroupUnsub();
  currentChatIsGroup = false;
  chatActions.innerHTML = '';
  chatTitle.textContent = `Chat with ${friend}`;
  const id = [username,friend].sort().join('_');
  currentChatId = id;
  const docRef = db.collection('chats').doc(id);
  const doc = await docRef.get();
  if(!doc.exists) await docRef.set({isGroup:false,members:[username,friend],created:firebase.firestore.FieldValue.serverTimestamp()});
  currentMessagesUnsub = docRef.collection('messages').orderBy('timestamp').onSnapshot(renderMessages);
}

/* ---------------- Open Group ---------------- */
function openGroup(groupId){
  // clean previous
  if(currentMessagesUnsub) currentMessagesUnsub();
  if(currentGroupUnsub) currentGroupUnsub();
  currentChatIsGroup = true;
  currentChatId = groupId;
  const ref = db.collection('chats').doc(groupId);
  currentGroupUnsub = ref.onSnapshot(doc=>{
    if(!doc.exists) return;
    currentGroupData = doc.data();
    chatTitle.textContent = currentGroupData.groupName || 'Group';
    renderGroupActions(); // create members/add/kick/rename/leave buttons
  });
  currentMessagesUnsub = ref.collection('messages').orderBy('timestamp').onSnapshot(renderMessages);
}

/* ---------------- Render messages ---------------- */
function renderMessages(snapshot){
  clear(messagesEl);
  snapshot.forEach(d=>{
    const m = d.data();
    const el = document.createElement('div');
    if(m.sender === 'System'){
      el.className = 'message system';
      el.textContent = m.text;
      messagesEl.appendChild(el);
      return;
    }
    const isMe = m.sender === username;
    el.className = 'message ' + (isMe ? 'self' : 'other');
    // sender label for group
    if(currentChatIsGroup){
      const span = document.createElement('span'); span.className='msg-sender'; span.textContent = m.sender + ': ';
      el.appendChild(span);
    }
    if(m.text) el.appendChild(document.createTextNode(m.text));
    if(m.imageData){
      const img = document.createElement('img'); img.src = m.imageData;
      img.style.maxWidth='300px'; img.style.maxHeight='300px'; img.style.display='block'; img.style.marginTop='8px'; img.style.borderRadius='8px';
      el.appendChild(img);
    }
    // delete button (visible on hover)
    if(isMe || m.sender === 'System'){
      const del = document.createElement('button'); del.className='delete-btn'; del.textContent='âœ–';
      del.title = 'Delete';
      del.onclick = async (e)=>{ e.stopPropagation(); await db.collection('chats').doc(currentChatId).collection('messages').doc(d.id).delete(); };
      el.appendChild(del);
    }
    messagesEl.appendChild(el);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* ---------------- Group action rendering ---------------- */
function renderGroupActions(){
  clear(chatActions);
  if(!currentGroupData) return;
  // Members
  const membersBtn = document.createElement('button'); membersBtn.className='small'; membersBtn.textContent='Members';
  membersBtn.onclick = async ()=>{
    clear(membersList);
    const g = (await db.collection('chats').doc(currentChatId).get()).data();
    (g.members || []).forEach(u=>{
      const d = document.createElement('div'); d.className='member-item'; d.textContent = u;
      membersList.appendChild(d);
    });
    show(membersModal);
  };
  chatActions.appendChild(membersBtn);

  // Add (owner only)
  if(currentGroupData.owner === username){
    const addBtn = document.createElement('button'); addBtn.className='small'; addBtn.textContent='Add';
    addBtn.onclick = async ()=>{
      const name = prompt('Enter username to add:');
      if(!name) return;
      const userDoc = await db.collection('users').doc(name).get();
      if(!userDoc.exists){ alert('Invalid user'); return; }
      if((currentGroupData.members||[]).includes(name)){ alert('Already in group'); return; }
      await db.collection('chats').doc(currentChatId).update({members: firebase.firestore.FieldValue.arrayUnion(name)});
      await addSystem(currentChatId, `${name} has been added to the group chat`);
    };
    chatActions.appendChild(addBtn);
  }

  // Kick modal (owner only)
  if(currentGroupData.owner === username){
    const kickBtn = document.createElement('button'); kickBtn.className='small danger'; kickBtn.textContent='Kick';
    kickBtn.onclick = ()=>{
      clear(kickList);
      const members = (currentGroupData.members || []).filter(m=>m!==username);
      members.forEach(m=>{
        const label = document.createElement('label'); label.style.display='block'; label.style.marginBottom='6px';
        label.innerHTML = `<input type="radio" name="kick" value="${m}"> ${m}`;
        kickList.appendChild(label);
      });
      show(kickModal);
    };
    chatActions.appendChild(kickBtn);
  }

  // Rename (owner only)
  if(currentGroupData.owner === username){
    const renameBtn = document.createElement('button'); renameBtn.className='small'; renameBtn.textContent='Rename';
    renameBtn.onclick = async ()=>{
      const newName = prompt('New group name:', currentGroupData.groupName || '');
      if(!newName) return;
      await db.collection('chats').doc(currentChatId).update({groupName:newName});
      await addSystem(currentChatId, `${username} renamed the group to "${newName}"`);
    };
    chatActions.appendChild(renameBtn);
  }

  // Leave (everyone)
  const leaveBtn = document.createElement('button'); leaveBtn.className='small ghost'; leaveBtn.textContent='Leave';
  leaveBtn.onclick = async ()=>{
    await db.collection('chats').doc(currentChatId).update({members: firebase.firestore.FieldValue.arrayRemove(username)});
    await addSystem(currentChatId, `${username} left the group chat`);
    // reset view
    currentChatId = null; currentChatIsGroup = false; currentGroupData = null;
    chatTitle.textContent = 'Select a friend or group to chat';
    clear(messagesEl); clear(chatActions);
  };
  chatActions.appendChild(leaveBtn);
}

/* ---------------- Kick modal actions ---------------- */
kickCancel.onclick = ()=> hide(kickModal);
kickDo.onclick = async ()=>{
  const chosen = kickList.querySelector('input[name="kick"]:checked');
  if(!chosen) return alert('Select someone to kick');
  const who = chosen.value;
  await db.collection('chats').doc(currentChatId).update({members: firebase.firestore.FieldValue.arrayRemove(who)});
  await addSystem(currentChatId, `${who} was kicked from the group chat`);
  hide(kickModal);
};

/* ---------------- Members modal actions ---------------- */
membersClose.onclick = ()=> hide(membersModal);

/* ---------------- Send message & send image ---------------- */
sendBtn.onclick = async ()=>{
  const text = (textBox.value||'').trim();
  if(!currentChatId) return alert('Open a chat first');
  if(!text) return;
  await db.collection('chats').doc(currentChatId).collection('messages').add({
    sender: username, text, timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  textBox.value='';
};

imgBtn.onclick = ()=> fileInput.click();
fileInput.addEventListener('change', ()=>{
  const f = fileInput.files[0];
  if(!f) return;
  if(!currentChatId) return alert('Open a chat first');
  const r = new FileReader();
  r.onload = async (e)=>{
    await db.collection('chats').doc(currentChatId).collection('messages').add({
      sender: username, imageData: e.target.result, timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  };
  r.readAsDataURL(f);
  fileInput.value='';
});

/* ---------------- Open group helper used by sidebar ---------------- */
async function openGroup(groupId){
  // same as above openGroup to avoid duplicates
  if(currentMessagesUnsub) currentMessagesUnsub();
  if(currentGroupUnsub) currentGroupUnsub();
  currentChatIsGroup = true; currentChatId = groupId;
  const ref = db.collection('chats').doc(groupId);
  currentGroupUnsub = ref.onSnapshot(doc=>{
    if(!doc.exists) return;
    currentGroupData = doc.data();
    chatTitle.textContent = currentGroupData.groupName || 'Group';
    renderGroupActions();
  });
  currentMessagesUnsub = ref.collection('messages').orderBy('timestamp').onSnapshot(renderMessages);
}

/* ---------------- Initialization ---------------- */
loadFriends();
loadNotifications();
loadGroups();

logout.onclick = ()=>{ localStorage.removeItem('currentUser'); window.location.href='index.html'; };

</script>
</body>
</html>
